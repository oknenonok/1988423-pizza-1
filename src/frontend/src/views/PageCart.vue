<template>
  <form
    v-if="dataReady"
    method="post"
    class="layout-form"
    @submit.prevent="placeOrder"
  >
    <main class="content cart">
      <div v-if="!isCartEmpty" key="cart-notempty" class="container">
        <div class="cart__title">
          <h1 class="title title--big">Корзина</h1>
        </div>

        <CartPizzaList />

        <div class="cart__additional">
          <CartAdditionalList />
        </div>

        <div class="cart__form">
          <CartAddress />
        </div>
      </div>

      <div v-else key="cart-empty" class="sheet cart__empty">
        <p>В корзине нет ни одного товара</p>
      </div>
    </main>

    <CartFooter />

    <AppPopup :is-open="isOrderPopupOpened">
      <CartOrderPopup @close="hidePopup" />
    </AppPopup>
  </form>
</template>

<script lang="ts">
import { Component, Vue, Watch } from "vue-property-decorator";
import { mapGetters, mapState, mapActions } from "vuex";
import { RESET_STATE } from "@/store/mutations-types";
import CartPizzaList from "@/modules/cart/components/CartPizzaList.vue";
import CartAdditionalList from "@/modules/cart/components/CartAdditionalList.vue";
import CartAddress from "@/modules/cart/components/CartAddress.vue";
import CartFooter from "@/modules/cart/components/CartFooter.vue";
import CartOrderPopup from "@/modules/cart/components/CartOrderPopup.vue";
import orderCreateStatuses from "@/common/enums/orderCreateStatuses";
import AppPopup from "@/common/components/AppPopup.vue";
import { IUser } from "@/common/types";

@Component({
  components: {
    CartPizzaList,
    CartAdditionalList,
    CartAddress,
    CartFooter,
    CartOrderPopup,
    AppPopup,
  },

  computed: {
    ...mapState("Auth", ["user"]),
    ...mapState("Cart", ["orderCreateStatus"]),
    ...mapGetters("Cart", ["dataReady", "price", "isCartEmpty"]),
  },

  methods: {
    ...mapActions("Orders", ["createOrder"]),
  },
})
export default class PageCart extends Vue {
  title = "Корзина";
  isOrderPopupOpened = false;
  orderCreateStatus!: number;
  user!: IUser;
  createOrder!: () => void;

  @Watch("user")
  onUserChanged(newUser: string, oldUser: string) {
    if (newUser && !oldUser) {
      this.$store.dispatch("Addresses/load");
    }
  }

  created() {
    this.$store.dispatch("Cart/init");
  }

  async placeOrder() {
    this.isOrderPopupOpened = true;
    await this.createOrder();
  }

  hidePopup() {
    if (this.orderCreateStatus === orderCreateStatuses.SUCCESS) {
      setTimeout(() => {
        this.$store.commit(`Cart/${RESET_STATE}`);
        this.$router.push(this.user ? "/orders" : "/");
      }, 400);
    }
    this.isOrderPopupOpened = false;
  }
}
</script>

<style lang="scss">
.cart__title {
  margin-bottom: 15px;
}

.cart__additional {
  margin-top: 15px;
  margin-bottom: 25px;
}

.cart__empty {
  padding: 20px 30px;
}
</style>
